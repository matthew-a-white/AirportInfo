<!DOCTYPE html>

<html manifest="index.appcache">
  <title>Airport Data</title>
  <link rel="stylesheet" type="text/css" href="airports.css">
  <p style="font-size: 30pt; text-align: center; top: 25vh; left: 25vw; max-width: 50vw; position: relative;" id="airport"></p>
  <p style="font-size: 10pt; bottom: 0vh; left: 2vh; position: absolute">If a checkpoint is missing, it is due to a lack of or faulty data provided by the TSA</p>
  
  <form id="frm1" action="form_action.asp">
    3 letter code: <input type="text" id="input" >
  </form> 
  <button onclick="getID()">Submit</button>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <!-- <script src="jquery.min.js"></script> -->

  <script>
  	//START OF CHOOSING AIPORT
	var inputID = "ATL";

	//function getID() { 
	//	inputID = document.getElementById("input").value;
	//}
  	/*$('input[name="letterCode"]').change(function() {
		inputID = $('input[name="email"]').value;
	}); */
	//console.log(inputID);

  	//START SETUP OF VARIABLES AND FILES
    var data, allAirports, waiting, inputIndex, checkpointID, airportNameStart, airportNameEnd, airportName; 
    var nextAirportIndex, checkpointIndexStart, checkpointIndexEnd;
    var checkpointNames = [];

    var waitTimes = ["No wait", "1-10 min", "11-20 min", "21-30 min", "31+ min"];
    var infoAddress = "http://apps.tsa.dhs.gov/MyTSAWebService/GetWaitTimes.ashx?ap=" + inputID;
  	var checkpointsCovered = [];
  	var waitTimesIndices = [];
  	var updateWaitTimes = [];

  	var xhttp = new XMLHttpRequest();
  	xhttp.open("GET", "apcp.xml", false); //false makes it not asynchronous
  	xhttp.send();
  	allAirports = xhttp.responseXML; 

	var url = "http://apps.tsa.dhs.gov/MyTSAWebService/GetWaitTimes.ashx?ap=ATL"
    url = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent('select * from html where url="' + url + '"') + '&format=xml';
    $.ajax({
        type: "GET",
        url: url,
        async: false,
        success: function(text){
            data = text;
        },
        error: function(){
            alert("Error with YQL");
        },
        dataType: "text"
	});

	var firstConvertIndex = data.indexOf("documentelement");
	var secondConvertIndex = data.indexOf("documentelement", firstConvertIndex + 1);
	data = data.substring(firstConvertIndex - 1, secondConvertIndex + 16);
	waiting = jQuery.parseXML(data);
	waiting = waiting.getElementsByTagName("documentelement");
	console.log(waiting);

  	//END SETUP OF VARIABLES AND FILES
    /*
  	//START CREATING FUNCTIONS TO ORGANIZE CODE
  	function createTable(checkpoints, waitingTimes, updateTimes, changes) {
  		var body = document.getElementsByTagName('body')[0];
 		var tbl = document.createElement("table");
 		var tblBody = document.createElement("tbody");

  		for(var i = 0; i < checkpoints.length + 1; i++) {
  			var row = document.createElement("tr");
 
 			for (var j = 0; j < 4; j++) {
		      	var cell, cellText;
		      	if(i == 0) {
		      		cell = document.createElement("th");
		      	} else {
		            cell = document.createElement("td");
		      	}

		      	if(i == 0 && j == 0) {
		      		cellText = document.createTextNode("Checkpoint name");
		      	} else if(i == 0 && j == 1) {
		      		cellText = document.createTextNode("Waiting time");
		      	} else if(i == 0 && j == 2) {
		      		cellText = document.createTextNode("Last update");
		      	} else if(i == 0) {
		      		cellText = document.createTextNode("Changing wait time");
		      	} else if(j == 0) {
		      		cellText = document.createTextNode(checkpoints[i - 1]);
		      	} else if(j == 1) {
		      		cellText = document.createTextNode(waitingTimes[i - 1]);
		      	} else if(j == 2) {
		      		cellText = document.createTextNode(updateTimes[i - 1]);
		      	} else {
		      		cellText = document.createTextNode(changes[i - 1]);
		      	}

		      	cell.appendChild(cellText);
		      	row.appendChild(cell);
		    }

		    // add the row to the end of the table body
		    tblBody.appendChild(row);
		}
		 
		// put the <tbody> in the <table>
		tbl.appendChild(tblBody);
		// appends <table> into <body>
		body.appendChild(tbl);
		// sets the border attribute of tbl to 2;
		tbl.setAttribute("border", "1");
  	}

  	function isChanging(originalChecks, originalTimes, extraChecks, extraTimes) {
  		var finalChanging = [];
  		for(var i = 0; i < originalChecks.length; i++) {
  			if(extraChecks.indexOf(originalChecks[i]) == -1) {
  				finalChanging.push("Unknown");
  			}

  			for(var j = 0; j < extraChecks.length; j++) {
  				if(originalChecks[i] == extraChecks[j]) {
  					if(extraTimes[j] > originalTimes[i])
  						finalChanging.push("Decreasing");
  					else if(extraTimes[j] < originalTimes[i])
  						finalChanging.push("Increasing");
  					else
  						finalChanging.push("Not changing");
  				}
  			}
  		}
  		return finalChanging;
  	}

  	//END CREATING FUNCTIONS TO ORGANIZE CODE

  	//START GETTING DATA
  	var airportList = allAirports.getElementsByTagName("airport");
	
  	for(var i = 0; i < airportList.length; i++) {
  		if(airportList[i].childNodes[1].innerHTML == inputID) {
  			$("#airport").html(airportList[i].childNodes[0].innerHTML);
  	  			for(var j = 0; j < airportList[i].getElementsByTagName("checkpoints")[0].getElementsByTagName("checkpoint").length; j++) {
  					checkpointNames.push(airportList[i].getElementsByTagName("checkpoints")[0].getElementsByTagName("checkpoint")[j].childNodes[1].innerHTML);		
  				}
  		}
  	} 

  	var compiledDataCheck = [], compiledDataWait = [];
  	var unknownCheck = 0, unknownWait; //for unknown checkpoints
  	var compiledExtraChecks = [], extraWaitIndices = [], coveredExtras = [];
  	var unparsedUpdate, tIndex, endUpdateIndex;
  	var date, specificTime, unknownUpdateTime, indexOfUnknown = -1, counter = 0;
  	var extraZeroCheck = false;
     
	for(var i = 0; i < waiting.length; i++) {  //waiting is list of all WaitTimes nodes
		if(compiledExtraChecks.indexOf(waiting[i].childNodes[0].innerHTML) < 0) {
			if(checkpointsCovered.indexOf(waiting[i].childNodes[0].innerHTML) > -1) {
				compiledExtraChecks.push(waiting[i].childNodes[0].innerHTML);
				extraWaitIndices.push(waiting[i].childNodes[1].innerHTML);
			} 
		}

		if(checkpointsCovered.indexOf(waiting[i].childNodes[0].innerHTML) < 0 && waiting[i].childNodes[0].innerHTML != 0) {
			checkpointsCovered.push(waiting[i].childNodes[0].innerHTML);
			waitTimesIndices.push(waiting[i].childNodes[1].innerHTML);
			counter++;

			//FOR FINDING THE DATE
			unparsedUpdate = waiting[i].childNodes[2].innerHTML;
			tIndex = unparsedUpdate.indexOf("T");
			endUpdateIndex = unparsedUpdate.indexOf("-04:00");
			date = unparsedUpdate.substring(0, tIndex);
			specificTime = unparsedUpdate.substring(tIndex + 1, endUpdateIndex);
			updateWaitTimes.push(date + " at " + specificTime); 
		} else if(indexOfUnknown == -1 && waiting[i].childNodes[0].innerHTML == 0) {
			checkpointsCovered.push("0");
			waitTimesIndices.push(waiting[i].childNodes[1].innerHTML);
			indexOfUnknown = counter;
			unknownWait = waiting[i].childNodes[1].innerHTML; //this seems repetitive with code two lines above ***************

			//FOR FINDING THE DATE
			unparsedUpdate = waiting[i].childNodes[2].innerHTML;
			tIndex = unparsedUpdate.indexOf("T");
			endUpdateIndex = unparsedUpdate.indexOf("-04:00");
			date = unparsedUpdate.substring(0, tIndex);
			specificTime = unparsedUpdate.substring(tIndex + 1, endUpdateIndex);
			unknownUpdateTime = date + " at " + specificTime;
			updateWaitTimes.push(unknownUpdateTime);
		}
	}

	for(var i = 0; i < checkpointsCovered.length; i++) {
		if(i == indexOfUnknown) {
			compiledDataCheck.push("Unknown checkpoint");
			compiledDataWait.push(waitTimes[unknownWait - 1]);
		}

		if(checkpointsCovered[i] != 0) {
			compiledDataCheck.push(checkpointNames[checkpointsCovered[i] - 1]);
			compiledDataWait.push(waitTimes[waitTimesIndices[i] - 1]);
		}
	}

	var changingTimes = isChanging(checkpointsCovered, waitTimesIndices, compiledExtraChecks, extraWaitIndices);

	createTable(compiledDataCheck, compiledDataWait, updateWaitTimes, changingTimes);
	//END GETTING DATA   */

  </script>
  <div data-role="page" id="home">
  <p style="font-size: 0.7em; top: 15vh; left: 29vw; max-width: 50vw; position: relative;">Note: order of checkpoints comes from update time</p>

</html>














