<!DOCTYPE html>

<html manifest="index.appcache">
	<title>Airport Data</title>
	<meta name=viewport content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="airports.css">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="js.cookie.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

	<body>
		<p style="font-size: 30pt; text-align: center; top: 25vh; left: 19.5vw; max-width: 65vw; position: relative;" id="airport"></p>
		<p style="font-size: 0.7em; top: 48vh; left: 30vw; position: relative;" id ="note"></p>
		<p style="font-size: 10pt; bottom: 0vh; left: 2vh; position: absolute">If a checkpoint is missing, it is due to a lack of or faulty data provided by the TSA</p>
		<p style="left: 1vw; top: 2vh; text-align: center; position: absolute; color: white;">Airport code:</p>
		<input type="text" name="input" id="inputBox" style="left: 1vw; top: 7vh; position: absolute;">
		<button onclick="getID()" id="button" style="left: 0.8vw; top: 11vh; position: absolute;">Submit  ></button>

	  	<script>

	  		//FIRST INSTRUCTION
	  		$(function() {
	  			if(Cookies.get('getInstructions') == 'no') {
	  				$("#dialogContentText").html("Start by entering a 3 letter airport code. Do you wish to receive this message again?");
				    $( "#dialog" ).dialog({
				      resizable: true,
				      height: 200,
				      width: 500,
				      modal: false,
				      draggable: true,
				      dialogClass: "instructions success-dialog",
				      buttons: {
				        "No": function() {
				          $(this).dialog("close");
				          Cookies.set('getInstructions','no')
				        },
				        "Yes": function() {
				          $(this).dialog("close");
				          Cookies.set('getInstructions', 'yes');
				        }
				      }
				    });
				}
			 });  

	  		//QUICK SETUP OF INPUT
			$(function() {
				$("#inputBox").keyup(function(event) {
				    if(event.keyCode == 13) {
				        $("#button").click();
				    }
				});
			});
	  		
		  	//START OF CHOOSING AIRPORT
		  	var inputID, airportIncluded = false, removeTable = false;

			function getID() {
				airportIncluded = true;
				inputID = document.getElementsByName("input")[0].value;
				inputID = inputID.trim();

				if(removeTable) {
					tbl.remove();
					tblBody.remove();
				}
				main(inputID);
			}

			//END OF CHOOSING AIRPORT

		  	//START SETUP OF VARIABLES AND FILES
		    var data, allAirports, waiting, inputIndex, checkpointID; 
		    var nextAirportIndex, checkpointIndexStart, checkpointIndexEnd;
		    var checkpointNames = [];

		    var waitTimes = ["No wait", "1-10 min", "11-20 min", "21-30 min", "31+ min"];
		  	var checkpointsCovered = [];
		  	var waitTimesIndices = [];
		  	var updateWaitTimes = [];

		  	var xhttp = new XMLHttpRequest();
		  	xhttp.open("GET", "apcp.xml", false); //false makes it not asynchronous
		  	xhttp.send();
		  	allAirports = xhttp.responseXML; 
		  	//END FIRST SETUP

		  	//START AIRPORT NAME (this section was moved up here so that even with no data, the airport name will be displayed)
		  	
		  	function getAirport(id) {
		  		id = id.toUpperCase();

			  	var airportList = allAirports.getElementsByTagName("airport");
					var airportName;
				  	for(var i = 0; i < airportList.length; i++) {
				  		if(airportList[i].childNodes[1].innerHTML == id) {
				  			airportName = airportList[i].childNodes[0].innerHTML;
				  			$("#airport").html(airportList[i].childNodes[0].innerHTML);
				  	  			for(var j = 0; j < airportList[i].getElementsByTagName("checkpoints")[0].getElementsByTagName("checkpoint").length; j++) {
				  					checkpointNames.push(airportList[i].getElementsByTagName("checkpoints")[0].getElementsByTagName("checkpoint")[j].childNodes[1].innerHTML);		
				  				}
				  		}
				  	} 

			  	if(airportName === undefined) {
			  		alert("Please enter a valid airport code");
			  		$("#airport").html("");
			  		$("#note").html("");
			  		return false;
			  	}
			  	return true;
		  	}
		  	//END AIRPORT NAME

		  	//START SETUP OF VARIABLES AND FILES
		  	function ajaxRequest(id) {
				var url = "http://apps.tsa.dhs.gov/MyTSAWebService/GetWaitTimes.ashx?ap=" + id;
			    url = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent('select * from html where url="' + url + '"') + '&format=xml';
			    $.ajax({
			        type: "GET",
			        url: url,
			        async: false,
			        success: function(text){
			            data = text;
			        },
			        error: function(){
			            alert("Error with YQL");
			        },
			        dataType: "text"
				});

				$("#note").html("Note: order of checkpoints comes from update time");

				if(data.length < 310 && airportIncluded) {
					alert("NO DATA AVAILABLE");
					$("#note").html("");
				}

				var firstConvertIndex = data.indexOf("documentelement");
				var secondConvertIndex = data.indexOf("documentelement", firstConvertIndex + 1);
				data = data.substring(firstConvertIndex - 1, secondConvertIndex + 16);
				waiting = jQuery.parseXML(data);
				waiting = waiting.getElementsByTagName("documentelement")[0].getElementsByTagName("waittimes");
			}
		  	//END SETUP OF VARIABLES AND FILES
		  
		  	//START CREATING FUNCTIONS TO ORGANIZE CODE
		  	var body, tbl, tblBody;

		  	function createTable(checkpoints, waitingTimes, updateTimes, changes) {
		  		var tablePosition;

		  		removeTable = true;
		  		body = document.getElementsByTagName('body')[0];
		 		tbl = document.createElement("table");
		 		tblBody = document.createElement("tbody");

		 		if(checkpoints > 0) {
		 			removeTable = true;
		 		}

		  		for(var i = 0; i < checkpoints.length + 1; i++) {
		  			var row = document.createElement("tr");
		 
		 			for (var j = 0; j < 4; j++) {
				      	var cell, cellText;
				      	if(i == 0) {
				      		cell = document.createElement("th");
				      	} else {
				            cell = document.createElement("td");
				      	}

				      	if(i == 0 && j == 0) {
				      		cellText = document.createTextNode("Checkpoint name");
				      	} else if(i == 0 && j == 1) {
				      		cellText = document.createTextNode("Waiting times");
				      	} else if(i == 0 && j == 2) {
				      		cellText = document.createTextNode("Last update");
				      	} else if(i == 0) {
				      		cellText = document.createTextNode("Changing wait times");
				      	} else if(j == 0) {
				      		cellText = document.createTextNode(checkpoints[i - 1]);
				      	} else if(j == 1) {
				      		cellText = document.createTextNode(waitingTimes[i - 1]);
				      	} else if(j == 2) {
				      		cellText = document.createTextNode(updateTimes[i - 1]);
				      	} else {
				      		cellText = document.createTextNode(changes[i - 1]);
				      	}

				      	cell.appendChild(cellText);
				      	row.appendChild(cell);
				    }

				    // add the row to the end of the table body
				    tblBody.appendChild(row);
				}
				 
				// put the <tbody> in the <table>
				tbl.appendChild(tblBody);
				// appends <table> into <body>
				body.appendChild(tbl);
				// sets the border attribute of tbl to 2;
				tbl.setAttribute("border", "1");
		  	}

		  	function isChanging(originalChecks, originalTimes, extraChecks, extraTimes) {
		  		var finalChanging = [];
		  		for(var i = 0; i < originalChecks.length; i++) {
		  			if(extraChecks.indexOf(originalChecks[i]) == -1) {
		  				finalChanging.push("Unknown");
		  			}

		  			for(var j = 0; j < extraChecks.length; j++) {
		  				if(originalChecks[i] == extraChecks[j]) {
		  					if(extraTimes[j] > originalTimes[i])
		  						finalChanging.push("Decreasing");
		  					else if(extraTimes[j] < originalTimes[i])
		  						finalChanging.push("Increasing");
		  					else
		  						finalChanging.push("Not changing");
		  				}
		  			}
		  		}
		  		return finalChanging;
		  	}

		  	//END CREATING FUNCTIONS TO ORGANIZE CODE

		  	//START GETTING DATA
		  	var compiledDataCheck = [], compiledDataWait = [];
		  	var unknownCheck = 0, unknownWait; //for unknown checkpoints
		  	var compiledExtraChecks = [], extraWaitIndices = [], coveredExtras = [];
		  	var unparsedUpdate, tIndex, endUpdateIndex;
		  	var date, specificTime, unknownUpdateTime, indexOfUnknown = -1, counter = 0;
		  	var extraZeroCheck = false;
		     
		    function compileData() {
				for(var i = 0; i < waiting.length; i++) {  //waiting is list of all WaitTimes nodes
					if(compiledExtraChecks.indexOf(waiting[i].childNodes[0].innerHTML) < 0) {
						if(checkpointsCovered.indexOf(waiting[i].childNodes[0].innerHTML) > -1) {
							compiledExtraChecks.push(waiting[i].childNodes[0].innerHTML);
							extraWaitIndices.push(waiting[i].childNodes[1].innerHTML);
						} 
					}

					if(checkpointsCovered.indexOf(waiting[i].childNodes[0].innerHTML) < 0 && waiting[i].childNodes[0].innerHTML != 0) {
						checkpointsCovered.push(waiting[i].childNodes[0].innerHTML);
						waitTimesIndices.push(waiting[i].childNodes[1].innerHTML);
						counter++;

						//FOR FINDING THE DATE
						unparsedUpdate = waiting[i].childNodes[2].innerHTML;
						tIndex = unparsedUpdate.indexOf("T");
						endUpdateIndex = unparsedUpdate.indexOf("-04:00");
						date = unparsedUpdate.substring(0, tIndex);
						specificTime = unparsedUpdate.substring(tIndex + 1, endUpdateIndex);
						updateWaitTimes.push(date + " at " + specificTime); 
					} else if(indexOfUnknown == -1 && waiting[i].childNodes[0].innerHTML == 0) {
						checkpointsCovered.push("0");
						waitTimesIndices.push(waiting[i].childNodes[1].innerHTML);
						indexOfUnknown = counter;
						unknownWait = waiting[i].childNodes[1].innerHTML;

						//FOR FINDING THE DATE
						unparsedUpdate = waiting[i].childNodes[2].innerHTML;
						tIndex = unparsedUpdate.indexOf("T");
						endUpdateIndex = unparsedUpdate.indexOf("-04:00");
						date = unparsedUpdate.substring(0, tIndex);
						specificTime = unparsedUpdate.substring(tIndex + 1, endUpdateIndex);
						unknownUpdateTime = date + " at " + specificTime;
						updateWaitTimes.push(unknownUpdateTime);
					}
				}

				for(var i = 0; i < checkpointsCovered.length; i++) {
					if(i == indexOfUnknown) {
						compiledDataCheck.push("Unknown checkpoint");
						compiledDataWait.push(waitTimes[unknownWait - 1]);
					}

					if(checkpointsCovered[i] != 0) {
						compiledDataCheck.push(checkpointNames[checkpointsCovered[i] - 1]);
						compiledDataWait.push(waitTimes[waitTimesIndices[i] - 1]);
					}
				}

				var changingTimes = isChanging(checkpointsCovered, waitTimesIndices, compiledExtraChecks, extraWaitIndices);

				createTable(compiledDataCheck, compiledDataWait, updateWaitTimes, changingTimes);
			}
			//END GETTING DATA 

			//START RESET FUNCTION
			function removeData() {
				checkpointsCovered = [], waitTimesIndice = [], compiledExtraChecks = [], extraWaitIndices = [], compiledDataCheck = [], compiledDataWait = [], updateWaitTimes = [], changingTimes = [];
				airportIncluded = false;
			}
			//END RESET FUNCTION

			function main(id) {
				if(getAirport(id)) {
					ajaxRequest(id);
					compileData();
					removeData();
				}
			}   
			
	  	</script>
	  	<div id="dialog" class="ui-dialog-content" title="Instructions">
			<p id="dialogContentText"></p>
		</div> 
	</body>
</html>














